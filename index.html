<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Video Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #000; color: white; font-family: monospace; }
        .log-box { background: #111; border: 1px solid #333; height: 150px; overflow-y: scroll; padding: 10px; font-size: 12px; margin-top: 10px; }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <h1 class="text-xl font-bold mb-4 text-blue-400">Connection Debugger</h1>

    <div id="status" class="w-full bg-blue-900 p-4 rounded text-center font-bold mb-4">
        Initializing...
    </div>

    <div class="flex gap-2 w-full max-w-lg h-48">
        <video id="localVideo" autoplay muted playsinline class="w-1/2 bg-gray-800 rounded border border-gray-600"></video>
        <video id="remoteVideo" autoplay playsinline class="w-1/2 bg-gray-800 rounded border border-gray-600"></video>
    </div>

    <div class="w-full max-w-lg mt-4">
        <p>System Logs:</p>
        <div id="logs" class="log-box text-green-400"></div>
    </div>

    <script>
        const logBox = document.getElementById('logs');
        const statusEl = document.getElementById('status');
        
        function log(msg, color = "text-green-400") {
            const div = document.createElement('div');
            div.className = color;
            div.innerText = `> ${msg}`;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function init() {
            try {
                // 1. Camera Check
                log("Requesting Camera...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = stream;
                log("Camera Success!", "text-blue-400");

                // 2. Network Check
                statusEl.innerText = "Connecting to Peer Cloud...";
                log("Attempting to reach PeerJS Server...");

                const peer = new Peer(null, {
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' }
                        ]
                    }
                });

                // TIMEOUT CHECK: If not connected in 10 seconds
                const timeoutCheck = setTimeout(() => {
                    if (!peer.id) {
                        statusEl.innerText = "CONNECTION TIMED OUT";
                        statusEl.className = "w-full bg-red-900 p-4 rounded text-center font-bold mb-4";
                        log("ERROR: Could not reach PeerJS Cloud. ISP blocking?", "text-red-500 font-bold");
                        log("TRY: Connecting to a different WiFi or using a VPN.", "text-yellow-400");
                    }
                }, 10000);

                peer.on('open', (id) => {
                    clearTimeout(timeoutCheck);
                    statusEl.innerText = "CONNECTED! ID Generated.";
                    statusEl.className = "w-full bg-green-900 p-4 rounded text-center font-bold mb-4";
                    log(`SUCCESS! My ID: ${id}`, "text-white font-bold bg-green-800 p-1");
                    log("Ready to share link.", "text-blue-300");
                });

                peer.on('error', (err) => {
                    clearTimeout(timeoutCheck);
                    statusEl.innerText = "ERROR OCCURRED";
                    statusEl.className = "w-full bg-red-900 p-4 rounded text-center font-bold mb-4";
                    log(`CRITICAL ERROR: ${err.type}`, "text-red-500 font-bold text-lg");
                    log(`${err}`, "text-red-400");
                });

                peer.on('disconnected', () => {
                    log("WARNING: Disconnected from signaling server.", "text-yellow-500");
                    log("Attempting reconnect...", "text-gray-400");
                    peer.reconnect();
                });

            } catch (err) {
                statusEl.innerText = "CAMERA FAILED";
                statusEl.className = "w-full bg-red-900 p-4 rounded text-center font-bold mb-4";
                log(`Camera Error: ${err.name}`, "text-red-500 font-bold");
                log("Please allow camera permissions and reload.", "text-yellow-400");
            }
        }

        init();
    </script>
</body>
</html>
