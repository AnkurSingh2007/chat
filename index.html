<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Link Video</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; }
        video { transform: scaleX(-1); background: #000; border-radius: 8px; object-fit: cover; }
        .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <div id="status" class="fixed top-4 bg-blue-600 px-4 py-2 rounded-full text-sm font-bold shadow-lg z-50">
        Initializing...
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-5xl h-[70vh]">
        <div class="relative w-full h-full glass rounded-xl overflow-hidden">
            <video id="localVideo" autoplay muted playsinline class="w-full h-full"></video>
            <div class="absolute bottom-4 left-4 bg-black/50 px-3 py-1 rounded text-sm">YOU</div>
        </div>

        <div class="relative w-full h-full glass rounded-xl overflow-hidden flex items-center justify-center">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full"></video>
            <div id="waitingMsg" class="absolute text-center">
                <p class="text-gray-400 animate-pulse">Waiting for connection...</p>
            </div>
        </div>
    </div>

    <div id="hostControls" class="mt-8 hidden flex-col items-center gap-4">
        <p class="text-gray-400">Send this link to your friend to start:</p>
        <div class="flex gap-2">
            <input id="shareLink" readonly class="bg-gray-800 text-green-400 px-4 py-2 rounded border border-gray-600 w-64 text-sm">
            <button onclick="copyLink()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold transition">
                COPY LINK
            </button>
        </div>
    </div>

    <script>
        // 1. Setup PeerJS with Google's Free STUN servers (Fixes network blocks)
        const peerConfig = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        const peer = new Peer(null, peerConfig);
        let localStream;
        
        // Check URL for "call" ID
        const urlParams = new URLSearchParams(window.location.search);
        const targetId = urlParams.get('call');

        // UI Elements
        const statusEl = document.getElementById('status');
        const hostControls = document.getElementById('hostControls');
        const shareInput = document.getElementById('shareLink');

        // --- STARTUP ---
        async function init() {
            try {
                // Get Camera/Mic
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                statusEl.innerText = "Camera Ready. Connecting to Cloud...";

                // Handle PeerJS ID generation
                peer.on('open', (id) => {
                    console.log("My ID: " + id);
                    
                    if (targetId) {
                        // SCENARIO A: I am the GUEST (I clicked a link)
                        statusEl.innerText = "Connecting to friend...";
                        connectToHost(targetId);
                    } else {
                        // SCENARIO B: I am the HOST (I need to share a link)
                        statusEl.innerText = "Waiting for friend to join...";
                        hostControls.classList.remove('hidden');
                        
                        // Create the Magic Link
                        const magicLink = window.location.origin + window.location.pathname + '?call=' + id;
                        shareInput.value = magicLink;
                        
                        // Listen for incoming call
                        peer.on('call', answerCall);
                    }
                });

                peer.on('error', (err) => {
                    console.error(err);
                    statusEl.innerText = "Error: " + err.type;
                    statusEl.className = "fixed top-4 bg-red-600 px-4 py-2 rounded-full text-sm font-bold shadow-lg z-50";
                });

            } catch (err) {
                statusEl.innerText = "Camera Access Denied! Allow permissions.";
                statusEl.className = "fixed top-4 bg-red-600 px-4 py-2 rounded-full text-sm font-bold shadow-lg z-50";
            }
        }

        // --- LOGIC ---

        // Guest calls Host
        function connectToHost(hostId) {
            const call = peer.call(hostId, localStream);
            handleStream(call);
        }

        // Host answers Guest
        function answerCall(call) {
            hostControls.classList.add('hidden'); // Hide link once connected
            statusEl.innerText = "Friend calling... Connecting...";
            call.answer(localStream);
            handleStream(call);
        }

        // Handle the video stream
        function handleStream(call) {
            call.on('stream', (remoteStream) => {
                statusEl.innerText = "Connected! âœ…";
                statusEl.className = "fixed top-4 bg-green-600 px-4 py-2 rounded-full text-sm font-bold shadow-lg z-50";
                document.getElementById('remoteVideo').srcObject = remoteStream;
                document.getElementById('waitingMsg').classList.add('hidden');
            });
            
            call.on('close', () => alert("Call Ended"));
        }

        function copyLink() {
            shareInput.select();
            document.execCommand("copy");
            alert("Link Copied! Send it to your friend.");
        }

        init();
    </script>
</body>
</html>
